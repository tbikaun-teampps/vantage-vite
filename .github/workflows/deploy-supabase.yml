name: Deploy Supabase Migrations

on:
  push:
    branches:
      - staging
      - main

jobs:
  deploy-migrations:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
      
      - name: Setup Supabase CLI
        uses: supabase/setup-cli@v1
        with:
          version: latest
      
      # Determine environment based on branch
      - name: Set environment
        id: set-env
        run: |
          if [[ "${{ github.ref }}" == "refs/heads/main" ]]; then
            echo "ENVIRONMENT=production" >> $GITHUB_OUTPUT
            echo "PROJECT_REF=${{ secrets.PRODUCTION_PROJECT_REF }}" >> $GITHUB_OUTPUT
          elif [[ "${{ github.ref }}" == "refs/heads/staging" ]]; then
            echo "ENVIRONMENT=staging" >> $GITHUB_OUTPUT
            echo "PROJECT_REF=${{ secrets.STAGING_PROJECT_REF }}" >> $GITHUB_OUTPUT
          fi
      
      # Optional: Backup production database before migrations
      - name: Backup database (Production only)
        if: steps.set-env.outputs.ENVIRONMENT == 'production'
        run: |
          supabase db dump \
            -f backup-$(date +%Y%m%d-%H%M%S).sql \
            --project-ref ${{ steps.set-env.outputs.PROJECT_REF }}
        env:
          SUPABASE_ACCESS_TOKEN: ${{ secrets.SUPABASE_ACCESS_TOKEN }}
      
      # Link to appropriate project
      - name: Link Supabase project
        run: |
          supabase link --project-ref ${{ steps.set-env.outputs.PROJECT_REF }}
        env:
          SUPABASE_ACCESS_TOKEN: ${{ secrets.SUPABASE_ACCESS_TOKEN }}
      
      # Run migrations
      - name: Push database migrations
        run: supabase db push
        env:
          SUPABASE_ACCESS_TOKEN: ${{ secrets.SUPABASE_ACCESS_TOKEN }}
      
      # Verify migrations
      - name: List applied migrations
        run: supabase migration list
        env:
          SUPABASE_ACCESS_TOKEN: ${{ secrets.SUPABASE_ACCESS_TOKEN }}
      
      # Optional: Run seed data for staging
      - name: Seed staging database
        if: steps.set-env.outputs.ENVIRONMENT == 'staging'
        run: |
          if [ -f "supabase/seed.sql" ]; then
            supabase db seed
          fi
        env:
          SUPABASE_ACCESS_TOKEN: ${{ secrets.SUPABASE_ACCESS_TOKEN }}
      
      # Notify on success (optional)
      - name: Notify deployment success
        if: success()
        run: |
          echo "âœ… Migrations deployed to ${{ steps.set-env.outputs.ENVIRONMENT }}"